<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>collatz-m4m6 Tool Specification Report</title>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<style>
  body {
    font-family: "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
    max-width: 960px;
    margin: 0 auto;
    padding: 2rem;
    line-height: 1.8;
    color: #222;
    background: #fafafa;
  }
  h1 {
    font-size: 1.6rem;
    border-bottom: 3px solid #333;
    padding-bottom: 0.5rem;
    margin-top: 2rem;
  }
  h2 {
    font-size: 1.3rem;
    border-left: 4px solid #2a6496;
    padding-left: 0.8rem;
    margin-top: 2.5rem;
  }
  h3 {
    font-size: 1.1rem;
    color: #2a6496;
    margin-top: 2rem;
  }
  h4 {
    font-size: 1rem;
    color: #555;
    margin-top: 1.5rem;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    margin: 1.2rem 0;
    font-size: 0.92rem;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 0.5rem 0.8rem;
    text-align: left;
  }
  th {
    background: #e0e8f0;
    font-weight: 600;
  }
  td.num {
    text-align: right;
    font-family: "Consolas", "Source Code Pro", monospace;
  }
  .meta {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 2rem;
  }
  code {
    font-family: "Consolas", "Source Code Pro", monospace;
    background: #eee;
    padding: 0.1rem 0.3rem;
    border-radius: 3px;
    font-size: 0.9em;
  }
  pre {
    background: #f0f4f8;
    border: 1px solid #c8d6e5;
    border-radius: 6px;
    padding: 1rem 1.5rem;
    overflow-x: auto;
    font-family: "Consolas", "Source Code Pro", monospace;
    font-size: 0.88rem;
    line-height: 1.6;
    margin: 1rem 0;
  }
  .box {
    background: #f0f4f8;
    border: 1px solid #c8d6e5;
    border-radius: 6px;
    padding: 1rem 1.5rem;
    margin: 1.2rem 0;
  }
  .box-warn {
    background: #fff8f0;
    border: 1px solid #e0c8a0;
  }
  footer {
    margin-top: 3rem;
    padding-top: 1rem;
    border-top: 1px solid #ccc;
    color: #888;
    font-size: 0.85rem;
  }
  ul { margin: 0.5rem 0 1rem 1.5rem; }
  li { margin-bottom: 0.4rem; }
</style>
</head>
<body>

<h1>collatz-m4m6 Tool Specification Report</h1>
<p class="meta">
  <strong>Version</strong>: 0.2.0 &nbsp;|&nbsp;
  <strong>Date</strong>: 2026-02-07 &nbsp;|&nbsp;
  <strong>Language</strong>: Rust (edition 2021)
</p>

<!-- ========== Section 1 ========== -->
<h2>1. Overview</h2>
<p>
  A scan and analysis tool based on the m4/m6 pair predicate decomposition of the Collatz-type map \(T(n) = (xn+1)/2^d\).
  This is an implementation of Algorithm 7.1 from the paper "Pair Predicate Decomposition of the Collatz-type Map \((xn+1)/2^d\) and Structural Closure of \(3n+1\),"
  providing the following features.
</p>
<ul>
  <li>Single-step scan for any \(xn+1\)-type map (where \(x-1\) is a power of 2)</li>
  <li>Trajectory tracking (recording all steps until reaching 1)</li>
  <li>Range verification (parallel verification of large numbers using the stopping time method)</li>
  <li>Aggregation and visualization of GPK (Generate/Propagate/Kill) statistics</li>
  <li>Interactive operation via GUI</li>
</ul>

<!-- ========== Section 2 ========== -->
<h2>2. Supported Parameters</h2>
<table>
  <tr><th>Parameter \(x\)</th><th>\(s = \log_2(x-1)\)</th><th>Reference pattern</th><th>Status</th></tr>
  <tr><td>3</td><td>1 (odd)</td><td>ref_R=(a[i-1], b[i]), ref_L=(b[i], a[i])</td><td>Dedicated optimization available</td></tr>
  <tr><td>5</td><td>2 (even)</td><td>ref_R=(b[i-1], b[i]), ref_L=(a[i-1], a[i])</td><td>Dedicated optimization available</td></tr>
  <tr><td>9</td><td>3 (odd)</td><td>Generic pattern</td><td>Generic routine</td></tr>
  <tr><td>17</td><td>4 (even)</td><td>Generic pattern</td><td>Generic routine</td></tr>
  <tr><td>33, 65, 129, &hellip;</td><td>5, 6, 7, &hellip;</td><td>Generic pattern</td><td>Generic routine</td></tr>
</table>
<p><strong>Constraint</strong>: \(x \geq 3\) and \(x-1\) must be a power of 2.</p>

<!-- ========== Section 3 ========== -->
<h2>3. Architecture</h2>

<h3>3.1 Module Structure</h3>
<pre>
src/
├── lib.rs            # Crate root (public API definitions)
├── main.rs           # CLI entry point
├── gui.rs            # GUI entry point (egui)
├── pair_number.rs    # PairNumber type (m4/m6 bit-pair representation)
├── reference.rs      # Reference patterns (implementation of Table 3.1)
├── scan.rs           # Single-step scan (including GPK classification)
├── postprocess.rs    # Postprocessing (MSB trimming, trailing zero removal, re-pairing)
├── trajectory.rs     # Trajectory tracking / stopping time calculation
└── verify.rs         # Range parallel verification (rayon)
</pre>

<h3>3.2 Data Flow</h3>
<pre>
Input n (BigUint)
    │
    ├─ [Trajectory tracking path] ─── PairNumber conversion → scan::collatz_step → postprocess → record
    │                     (retains m4/m6, GPK sequence, d for each step)
    │
    └─ [Stopping time path] ─── u128 direct arithmetic → BigUint fallback
                          (fast arithmetic without going through PairNumber; GPK computed via bit extraction)
</pre>

<h3>3.3 Dual-Path Design</h3>
<table>
  <tr><th></th><th>Trajectory tracking path</th><th>Stopping time path</th></tr>
  <tr><td><strong>Purpose</strong></td><td>Single analysis (GUI single tab)</td><td>Range verification (GUI range tab)</td></tr>
  <tr><td><strong>Internal representation</strong></td><td>PairNumber (Vec&lt;u8&gt; per bit)</td><td>u128 / BigUint direct arithmetic</td></tr>
  <tr><td><strong>GPK acquisition</strong></td><td>By-product of scan function (GPK sequence per pair)</td><td>Computed directly from bit sequence (statistics only)</td></tr>
  <tr><td><strong>Output</strong></td><td>n', d, GPK sequence for all steps</td><td>Stopping time + GPK aggregate statistics</td></tr>
  <tr><td><strong>Speed</strong></td><td>Slow (detailed data for research)</td><td>Fast (for bulk verification)</td></tr>
</table>

<!-- ========== Section 4 ========== -->
<h2>4. Stopping Time Fast Path</h2>

<h3>4.1 <code>stopping_time_u64_fast</code></h3>
<p>Optimized path for u64 input.</p>

<h4>Phase 1: u128 Arithmetic</h4>
<ul>
  <li>Compute <code>current * x + 1</code> in u128</li>
  <li>Obtain \(d\) via <code>trailing_zeros()</code>, then right-shift</li>
  <li>GPK is classified directly from bits of the u128 value</li>
  <li>Overflow threshold: <code>(u128::MAX - 1) / x</code></li>
</ul>

<h4>Phase 2: BigUint Fallback</h4>
<ul>
  <li>Automatic transition upon u128 overflow</li>
  <li>In-place arithmetic via <code>BigUint::*=</code>, <code>+=</code>, <code>&gt;&gt;=</code></li>
  <li>GPK extracted from bits via <code>to_bytes_le()</code></li>
</ul>

<h3>4.2 <code>stopping_time_with_gpk</code></h3>
<p>Generic path for BigUint input. Same logic as Phase 2.</p>

<h3>4.3 Safety Limits</h3>
<table>
  <tr><th>Limit</th><th>Value</th><th>Purpose</th></tr>
  <tr><td>MAX_PAIR_COUNT</td><td class="num">10,000 pairs</td><td>Memory limit for trajectory tracking path</td></tr>
  <tr><td>MAX_BIT_LENGTH</td><td class="num">20,000 bits</td><td>Bit-length limit for stopping time path</td></tr>
  <tr><td>max_steps</td><td class="num">Configurable in GUI</td><td>Truncation for divergent series</td></tr>
</table>

<!-- ========== Section 5 ========== -->
<h2>5. GPK Statistics</h2>

<h3>5.1 Classification Rules</h3>
<p>
  For each pair position \(i\), from the 4 bits \((p_r, q_r, p_l, q_l)\) based on the reference pattern:
</p>
<pre>
m6 stage: g_mid = p_r &amp; q_r,  p_mid = p_r ^ q_r
m4 stage: g_out = p_l &amp; q_l,  p_out = p_l ^ q_l
Serial composition: G_i = g_out | (p_out &amp; g_mid)
          P_i = p_out &amp; p_mid
          K_i = otherwise
</pre>

<h3>5.2 Carry Chain Length</h3>
<p>
  Records the maximum length of chains starting from the initial carry \(c=1\) and chains after regeneration by G.
  Aggregated as a histogram (distance 0&ndash;127).
</p>

<h3>5.3 Measured GPK Distribution (\(n \leq 10^7\), max_steps=500)</h3>
<table>
  <tr><th></th><th>\(3n+1\)</th><th>\(5n+1\)</th><th>\(17n+1\)</th></tr>
  <tr><td><strong>G%</strong></td><td class="num">38.41</td><td class="num">36.91</td><td class="num">37.26</td></tr>
  <tr><td><strong>P%</strong></td><td class="num">28.32</td><td class="num">25.45</td><td class="num">25.09</td></tr>
  <tr><td><strong>K%</strong></td><td class="num">33.26</td><td class="num">37.64</td><td class="num">37.65</td></tr>
  <tr><td><strong>G/K ratio</strong></td><td class="num">1.15</td><td class="num">0.98</td><td class="num">0.99</td></tr>
</table>

<!-- ========== Section 6 ========== -->
<h2>6. GUI Specification</h2>

<h3>6.1 Configuration</h3>
<ul>
  <li><strong>Framework</strong>: egui (eframe 0.29) + egui_plot 0.29</li>
  <li><strong>Japanese font</strong>: Yu Gothic / MS Gothic / Meiryo (auto-detected)</li>
  <li><strong>Window size</strong>: 900 &times; 700</li>
</ul>

<h3>6.2 Top Panel</h3>
<table>
  <tr><th>Element</th><th>Description</th></tr>
  <tr><td><code>x =</code></td><td>Parameter for \(xn+1\). Only values where \(x-1\) is a power of 2 are accepted</td></tr>
  <tr><td><code>max_steps:</code></td><td>Maximum number of iteration steps. Default 10000</td></tr>
  <tr><td>Tab switching</td><td>Single analysis / Range analysis / Analysis</td></tr>
</table>

<h3>6.3 Single Analysis Tab</h3>
<ul>
  <li><strong>Single-step execution</strong>: Performs one \((xn+1)/2^d\) operation on \(n\). Displays \(n'\), \(d\), GPK sequence, and carry chain length</li>
  <li><strong>Trajectory tracking</strong>: Iterates until reaching 1 (or max_steps/bit-length limit). Runs on a background thread
    <ul>
      <li>Cancellable (stop button)</li>
      <li>Progress display (step count, digit count) updated every 200ms</li>
      <li>Result: step count, \(\Sigma d\), maximum digit count, GPK statistics, first 100 steps of trajectory</li>
      <li>CSV + summary TXT saved automatically</li>
    </ul>
  </li>
</ul>

<h3>6.4 Range Analysis Tab</h3>
<ul>
  <li><strong>Range specification</strong>: Verifies all odd numbers from start value&ndash;end value</li>
  <li><strong>Parallel processing</strong>: Automatic parallelization via rayon (u64 range is divided into chunks)</li>
  <li><strong>Progress bar</strong>: Updated every 100 numbers, displaying nums/s</li>
  <li>Cancellable</li>
  <li><strong>Results</strong>: Number verified, convergence determination, maximum stopping time, GPK statistics, GPK distribution graph, carry chain length graph</li>
  <li>Summary TXT saved automatically</li>
</ul>

<h3>6.5 Analysis Tab</h3>
<ul>
  <li>Displays a list of log files in the <code>output/</code> directory</li>
  <li>Selecting a file re-displays parameters, GPK statistics, and graphs</li>
  <li>Automatically parses the log file format</li>
</ul>

<!-- ========== Section 7 ========== -->
<h2>7. Output Files</h2>

<h3>7.1 Save Location</h3>
<p>The <code>output/</code> folder in the same directory as the exe (created automatically).</p>

<h3>7.2 File Naming Convention</h3>
<pre>
gui_trace_{x}n1_{n}[_stopped]_{timestamp}.txt     # Trajectory tracking summary
gui_trace_{x}n1_{n}.csv                            # Trajectory tracking CSV
gui_verify_{x}n1_{start}-{end}[_stopped]_{timestamp}.txt  # Range verification summary
</pre>

<h3>7.3 Summary File Format</h3>
<pre>
# collatz-m4m6 verify
range = [3, 9999999]
x = 5
total_checked = 4999999
all_converged = false
max_stopping_time = 490
max_stopping_time_n = 4580349

# GPK
G = 17746659852
P = 12236187544
K = 18094218711
total_pairs = 48077066107
total_steps = 897149444
G% = 36.9129
P% = 25.4512
K% = 37.6359

# Carry chain histogram
0: 720342
1: 1400349
...

elapsed = 79.0672604s
</pre>

<h3>7.4 CSV Format (Trajectory Tracking)</h3>
<pre>
step,n,d,digits,gpk,G,P,K,max_carry_chain
0,27,0,2,,0,0,0,0
1,41,1,2,PGP,1,2,0,2
...
</pre>

<!-- ========== Section 8 ========== -->
<h2>8. Build</h2>

<h3>8.1 Prerequisites</h3>
<ul>
  <li>Rust toolchain (stable)</li>
  <li>MSYS2 MinGW64 (on Windows, native dependency for egui)</li>
</ul>

<h3>8.2 Build Commands</h3>
<pre>
# Use build_gui.ps1
$env:PATH = "C:\msys64\mingw64\bin;C:\Users\ykihi\.cargo\bin;" + $env:PATH
cargo build --release --features gui --bin collatz-gui
</pre>

<h3>8.3 Execution</h3>
<pre>
target\release\collatz-gui.exe
</pre>

<!-- ========== Section 9 ========== -->
<h2>9. Performance Characteristics</h2>

<h3>9.1 Benchmark (\(n \leq 10^7\), max_steps=500)</h3>
<table>
  <tr><th>\(x\)</th><th>Time</th><th>nums/s</th><th>Avg steps/number</th></tr>
  <tr><td>3</td><td class="num">0.49s</td><td class="num">10,200,000</td><td class="num">3.5</td></tr>
  <tr><td>5</td><td class="num">79s</td><td class="num">63,300</td><td class="num">179</td></tr>
  <tr><td>17</td><td class="num">1654s</td><td class="num">3,020</td><td class="num">456</td></tr>
</table>

<h3>9.2 Scaling Factors for Speed</h3>
<ol>
  <li><strong>Convergence</strong>: \(3n+1\) converges for all numbers (average 3.5 steps); \(x \geq 5\) diverges (runs up to max_steps)</li>
  <li><strong>Bit growth</strong>: Larger \(x\) causes greater numerical growth per step, increasing BigUint arithmetic cost</li>
  <li><strong>u128 effective range</strong>: The first approximately \(128 / \log_2(x/2)\) steps are processed in u128; thereafter BigUint</li>
</ol>

<h3>9.3 Optimization History</h3>
<table>
  <tr><th>Version</th><th>Method</th><th>5n+1 (\(n \leq 10^6\)) speed</th></tr>
  <tr><td>v0.1</td><td>PairNumber + BigUint conversion/step</td><td class="num">46ms/number (92 numbers/5.65s)</td></tr>
  <tr><td>v0.2</td><td>BigUint direct arithmetic + u128 fast path</td><td class="num">8&mu;s/number (499,999/4s)</td></tr>
  <tr><td><strong>Improvement factor</strong></td><td></td><td class="num"><strong>Approx. 5,750x</strong></td></tr>
</table>

<!-- ========== Section 10 ========== -->
<h2>10. Known Limitations</h2>
<ol>
  <li><strong>Values of \(x\) where \(x-1\) is not a power of 2 are unsupported</strong>: \(x=7, 11, 13\), etc. require multiple addition stages and cannot be handled by the current two-stage structure</li>
  <li><strong>Inefficiency of PairNumber representation</strong>: Vec&lt;u8&gt; per bit (8x memory overhead). Used only in the trajectory tracking path</li>
  <li><strong>GUI log viewer</strong>: Only supports <code>.txt</code> files in <code>output/</code>. Direct viewing of CSV files is not yet implemented</li>
  <li><strong>Timestamp precision</strong>: Simplified calculation that does not account for leap years</li>
</ol>

<footer>
  collatz-m4m6 v0.4.0 &nbsp;|&nbsp; Rust edition 2021 &nbsp;|&nbsp; 2026-02-10
</footer>

</body>
</html>
